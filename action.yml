name: "Agentic Audits"
description: "A CLI-agnostic framework for running automated governance, audits, and refactoring missions with full user control via AI agents."
branding:
  icon: "crosshair"
  color: "blue"

inputs:
  mission:
    description: "The agent mission prompt to execute. Required if 'template' is not provided."
    required: false
    default: ""
  template:
    description: "Name of a template file in .github/templates/ (without extension). Mutually exclusive with 'mission'."
    required: false
    default: ""
  context_files:
    description: "File paths or globs for the agent to consider."
    required: false
    default: "."
  github_token:
    description: "GitHub token with Copilot access for authentication."
    required: true
  model:
    description: "Primary Copilot model to use (e.g. gpt-4o, claude-sonnet-4). Leave blank for default."
    required: false
    default: ""
  fallback_model:
    description: "Fallback model if the primary model hits a quota or availability error."
    required: false
    default: ""
  sources_config:
    description: "Path to a YAML file defining documentation sources (MCP servers, web URLs). If the file doesn't exist, no sources are configured."
    required: false
    default: ".github/sources.yml"
  dry_run:
    description: "If true, skips PR creation."
    required: false
    default: "false"
  pr_title:
    description: "Title for the Pull Request. If not provided, the agent will generate one."
    required: false
    default: ""
  pr_body:
    description: "Body content for the Pull Request. If not provided, the agent will generate one."
    required: false
    default: ""
  pr_branch:
    description: "Branch name for the Pull Request. If not provided, you should generate a relevant one."
    required: false
    default: ""
  pr_base:
    description: "Base branch for the Pull Request."
    required: false
    default: "main"
  pr_labels:
    description: "Labels to add to the Pull Request."
    required: false
    default: "automated-pr"

runs:
  using: "composite"
  steps:
    # ── 1. Unified Agent Lifecycle (Go) ────────────────────────────────
    - name: Run Agent Mission
      shell: bash
      env:
        MISSION: ${{ inputs.mission }}
        TEMPLATE: ${{ inputs.template }}
        SOURCES_CONFIG: ${{ inputs.sources_config }}
        GITHUB_TOKEN: ${{ inputs.github_token }}
        CONTEXT_FILES: ${{ inputs.context_files }}
        MODEL: ${{ inputs.model }}
        FALLBACK_MODEL: ${{ inputs.fallback_model }}
        DRY_RUN: ${{ inputs.dry_run }}
        PR_BASE: ${{ inputs.pr_base }}
        PR_BRANCH: ${{ inputs.pr_branch }}
        PR_TITLE: ${{ inputs.pr_title }}
        PR_BODY: ${{ inputs.pr_body }}
        PR_LABELS: ${{ inputs.pr_labels }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        go run ${{ github.action_path }}/src/main.go \
               ${{ github.action_path }}/src/sources.go \
               ${{ github.action_path }}/src/agent.go \
               ${{ github.action_path }}/src/setup.go \
               ${{ github.action_path }}/src/auth.go \
          --mission "$MISSION" \
          --template "$TEMPLATE" \
          --sources-config "$SOURCES_CONFIG" \
          --github-token "$GITHUB_TOKEN" \
          --context-files "$CONTEXT_FILES" \
          --model "$MODEL" \
          --fallback-model "$FALLBACK_MODEL" \
          --dry-run "${DRY_RUN:-false}"
